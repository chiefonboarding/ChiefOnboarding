{% load static %}
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Employee onboarding</title>
    <!-- CSS files -->
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/css/selectize.bootstrap4.min.css">
  </head>
  <body class="antialiased">
    <div class="wrapper">
      <header class="navbar navbar-expand-md navbar-light d-print-none">
        <div class="container-xl">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="navbar-nav flex-row order-md-last">
            <div class="nav-item dropdown d-none d-md-flex me-3">
              <a href="{% url 'settings:changelog' %}" class="nav-link px-0" tabindex="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 5a2 2 0 0 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6" /><path d="M9 17v1a3 3 0 0 0 6 0v-1" /></svg>
                {% if request.user.has_new_changelog_notifications %}
                <span class="badge bg-red"></span>
                {% endif %}
              </a>
            </div>
            <div class="nav-item dropdown">
              <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                {% include "_profile_image.html" %}
                <div class="d-none d-xl-block ps-2">
                  <div>{{ user.full_name }}</div>
                  <div class="mt-1 small text-muted">{{ user.get_role_display }}</div>
                </div>
              </a>
              <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                <a href="{% url 'logout' %}" class="dropdown-item">Logout</a>
              </div>
            </div>
          </div>
          <div class="collapse navbar-collapse" id="navbar-menu">
            <div class="d-flex flex-column flex-md-row flex-fill align-items-stretch align-items-md-center">
              <ul class="navbar-nav">
                <li class="nav-item dropdown {% if 'people' in request.path %}active{% endif %}">
                  <a class="nav-link dropdown-toggle " href="#navbar-people" data-bs-toggle="dropdown" role="button" aria-expanded="false" >
                    <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler-icons.io/i/star -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-users" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><circle cx="9" cy="7" r="4"></circle><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path><path d="M21 21v-2a4 4 0 0 0 -3 -3.85"></path></svg> </span>
                    </span>
                    <span class="nav-link-title">
                      People
                    </span>
                  </a>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="{% url 'admin:new_hires' %}">
                      New hires
                    </a>
                    <a class="dropdown-item" href="{% url 'admin:colleagues' %}">
                      Colleagues
                    </a>
                  </div>
                </li>
                <li class="nav-item dropdown {% if 'templates' in request.path %}active{% endif %}">
                  <a class="nav-link dropdown-toggle" href="#navbar-templates" data-bs-toggle="dropdown" role="button" aria-expanded="false" >
                    <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler-icons.io/i/star -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-box-multiple" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><rect x="7" y="3" width="14" height="14" rx="2"></rect><path d="M17 17v2a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-10a2 2 0 0 1 2 -2h2"></path></svg>
                    </span>
                    <span class="nav-link-title">
                      Templates
                    </span>
                  </a>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="{% url 'todo:list' %}" >
                      To do
                    </a>
                    <a class="dropdown-item" href="{% url 'resources:list' %}" >
                      Resources
                    </a>
                    <a class="dropdown-item" href="{% url 'introductions:list' %}" >
                      Introductions
                    </a>
                    <a class="dropdown-item" href="{% url 'appointments:list' %}" >
                      Appointments
                    </a>
                    <a class="dropdown-item" href="{% url 'preboarding:list' %}">
                      Preboarding
                    </a>
                    <a class="dropdown-item" href="{% url 'badges:list' %}">
                      Badges
                    </a>
                  </div>
                </li>
                <li class="nav-item {% if 'sequences' in request.path %}active{% endif %}">
                  <a class="nav-link" href="{% url 'sequences:list' %}" role="button" aria-expanded="false">
                    <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler-icons.io/i/star -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-subtask" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><line x1="6" y1="9" x2="12" y2="9"></line><line x1="4" y1="5" x2="8" y2="5"></line><path d="M6 5v11a1 1 0 0 0 1 1h5"></path><rect x="12" y="7" width="8" height="4" rx="1"></rect> <rect x="12" y="15" width="8" height="4" rx="1"></rect></svg>
                    </span>
                    <span class="nav-link-title">
                      Sequences
                    </span>
                  </a>
                </li>
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#navbar-tasks" data-bs-toggle="dropdown" role="button" aria-expanded="false" >
                    <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler-icons.io/i/star -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-list-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M3.5 5.5l1.5 1.5l2.5 -2.5"></path><path d="M3.5 11.5l1.5 1.5l2.5 -2.5"></path><path d="M3.5 17.5l1.5 1.5l2.5 -2.5"></path><line x1="11" y1="6" x2="20" y2="6"></line><line x1="11" y1="12" x2="20" y2="12"></line><line x1="11" y1="18" x2="20" y2="18"></line></svg>
                    </span>
                    <span class="nav-link-title">
                      Tasks
                    </span>
                  </a>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="{% url 'admin_tasks:mine' %}" >
                      Your tasks
                    </a>
                      <a class="dropdown-item" href="{% url 'admin_tasks:all' %}" >
                        All tasks
                      </a>
                  </div>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'settings:general' %}" role="button" aria-expanded="false">
                    <span class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler-icons.io/i/star -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-settings" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </span>
                    <span class="nav-link-title">
                      Settings
                    </span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </header>
      <div class="page-wrapper">
        <div class="container-xl">
          <!-- Page title -->
          <div class="page-header d-print-none">
            <div class="row align-items-center">
              <div class="col">
                <!-- Page pre-title -->
                <h2 class="page-title">
                  {{ title }}
                </h2>
                <div class="page-pretitle">
                  {{ subtitle }}
                </div>
              </div>
              <!-- Page title actions -->
              <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                  {% block actions %}
                  {% endblock %}
                  {% if add_action %}
                  <a href="{{ add_action }}" class="btn btn-primary d-none d-sm-inline-block">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
                    Add
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="page-body">
          <div class="container-xl">
            {% for message in messages %}
            <div class="alert alert-success">
              <p{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</p>
            </div>
            {% endfor %}
            {% block content %}
            {% endblock %}
          </div>
        </div>
        <footer class="footer footer-transparent d-print-none">
          <div class="container">
            <div class="row text-center align-items-center flex-row-reverse">
              <div class="col-lg-auto ms-lg-auto">
                <ul class="list-inline list-inline-dots mb-0">
                  <li class="list-inline-item"><a href="https://docs.chiefonboarding.com" class="link-secondary">Documentation</a></li>
                  <li class="list-inline-item">
                    <a href="https://github.com/chiefonboarding/chiefonboarding" target="_blank" class="link-secondary" rel="noopener">
                      <!-- Download SVG icon from http://tabler-icons.io/i/heart -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path></svg>
                      Source code
                    </a>
                  </li>
                </ul>
              </div>
              <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                <ul class="list-inline list-inline-dots mb-0">
                  <li class="list-inline-item">
                    <a href="https://chiefonboarding.com" class="link-secondary">ChiefOnboarding</a>
                  </li>
                  <li class="list-inline-item">
                    <a href="https://docs.chiefonboarding.com/changelog" class="link-secondary">v2.0.0</a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
    {% block js %}
    <script defer src="{% static 'js/tabler.js' %}"></script>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/js/standalone/selectize.min.js" type="text/javascript"></script>

    <script src="https://unpkg.com/htmx.org@1.6.1" integrity="sha384-tvG/2mnCFmGQzYC1Oh3qxQ7CkQ9kMzYjWZSNtrRZygHPDDqottzEJsqS4oUVodhW" crossorigin="anonymous"></script>
    <script>
      document.body.addEventListener('htmx:configRequest', function(event) {
        event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
      })
    </script>
    <script defer>
      $(document).ready(function () {
        // Trigger file input when clicking on upload button
        $(".upload-button").each(function (item) {
          $(this).on('click', function () {
            $(this).parent().find("input").click()
          })
        })

        $('select').selectize()

        $(".file-input").each(function (item) {
          $(this).on('change', function (file) {
            // ugly, needs clean up
            const originalButtonText = $(this).parent().find(".upload-button").text()
            const fileField = $(this)
            const fileIdInput = $(this).parent().find(".file-id")
            const newFileName = fileField.val().match(/[^\\/]*$/)[0];
            const fileNameSpan = $(this).parent().find(".file-name");
            const filePreview = $(this).parent().find("img");

            $(this).parent().find(".upload-button").text("uploading...")
            $.ajax({
              url: "/api/org/file",
              type: 'post',
              data: {'name': newFileName},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function( data ) {
                const fileMetaData = data
                $.ajax({
                  type: 'PUT',
                  url: data.file.url,
                  contentType: 'binary/octet-stream',
                  processData: false,
                  data: fileField.get()[0].files[0],
                  success: function () {
                    fileField.parent().find(".upload-button").text(originalButtonText)
                    fileIdInput.val(fileMetaData.file.id);
                    fileNameSpan.text(newFileName);
                    filePreview.attr("src", fileMetaData.file.get_url);
                  }
                });
              }
            });
          })
        })

      })
      // close modals when we are reloading the sequence part
      document.body.addEventListener("reload-sequence", function(evt){
          $('#modal-report').modal('hide')
          document.getElementById("add-condition-form").reset();
      })
      // reload selectboxes when we get a new form back from backend
      document.getElementById("condition_form").addEventListener('htmx:load', function(evt) {
        $('select').selectize()
      });
      document.body.addEventListener('htmx:afterOnLoad', function(evt) {
        $('select').selectize()
      });
      function triggerChange(event){
        const url = event.target.dataset.url
        const values = $('#' + event.target.getAttribute('id')).val()
        const prepped_values = {
          'condition_to_do': values
        }
        htmx.ajax("POST", url, { 'values': prepped_values, 'target': event.target })
      }
    </script>


    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script>
      window.onload = function(){
        if ($("#id_start_day").length) {
          new Litepicker({
            element: document.getElementById("id_start_day")
          });
        }
      }
    </script>

    {% if wysiwyg %}
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/nested-list@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/attaches@latest"></script>

    <script>
      window.onload = function(){
        function getSignedURL (file) {
          return $.ajax({
            url: "/api/org/file",
            type: 'post',
            data: {'name': file.name},
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
          })
        }
        function uploadFile (file, response) {
          return $.ajax({
            type: 'PUT',
            url: response.url,
            contentType: 'binary/octet-stream',
            processData: false,
            data: file
          })
        }
        const forms = document.querySelectorAll('form')
        forms.forEach(function(form) {
          if ('content_json' in form) {
            const content = JSON.parse(document.getElementById('content_json').textContent)
            form['content_json'].attributes.value.nodeValue = JSON.stringify(content)
            const editor = new EditorJS({
              autofocus: true,
              holder: 'element',
              data: content,
              tools: {
                header: Header,
                quote: Quote,
                list: {
                  class: NestedList,
                  inlineToolbar: true,
                },
                delimiter: Delimiter,
                image: {
                  class: ImageTool,
                  config: {
                    uploader: {
                      /**
                       * Upload file to the server and return an uploaded image data
                       * @param {File} file - file selected from the device or pasted by drag-n-drop
                       * @return {Promise.<{success, file: {url}}>}
                       */
                      async uploadByFile(file){
                        // your own uploading logic here
                        let response = await getSignedURL(file)
                        let completed = await uploadFile(file, response)
                        return {
                          success: 1,
                          file: {
                            url: response.get_url,
                            id: response.id
                          }
                        }
                      },
                    }
                  }
                },
                attaches: {
                  class: AttachesTool,
                  config: {
                    uploader: {
                      /**
                       * Upload file to the server and return an uploaded image data
                       * @param {File} file - file selected from the device or pasted by drag-n-drop
                       * @return {Promise.<{success, file: {url}}>}
                       */
                      async uploadByFile(file){
                        // your own uploading logic here
                        let response = await getSignedURL(file)
                        let completed = await uploadFile(file, response.file)
                        return response
                      },
                    }
                  }
                }
              },
              onChange: function (value) {
                value.saver.save().then(function(data) {
                  form['content_json'].attributes.value.nodeValue = JSON.stringify(data)
                })
              }
            });
          }
        })
      }
      htmx.onLoad(function(elt){
        $('select').selectize()
      })
    </script>
    {{ wysiwyg|json_script:"content_json" }}
    {% endif %}
    {% endblock %}
  </body>
</html>
