{% extends 'admin_base.html' %}
{% load static crispy_forms_tags %}
{% load i18n %}

{% block actions %}
  <div class="alert alert-warning mb-0" role="alert">
    {% translate "All changes will be saved automatically." %}
  </div>
  <a href="{% url 'people:department_create' %}" class="btn btn-primary">
    {% trans "Add" %}
  </a>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
  </div>
  <div class="col-7" id="departments-list">
    {% for department in departments %}
    <div class="card mb-4">
      <div class="card-header">
        <div class="col-11">
          <h3 class="card-title">{{ department }}</h3>
        </div>
        <div class="col-1 text-end">
          <a class="btn btn-azure btn-sm" href="{% url "people:department_update" department.pk %}">
            {% include "_edit_icon.html" %}
          </a>
        </div>
      </div>
      <div class="card-body">
        <div hx-trigger="reload-sequence from:body" hx-select="#timeline" hx-get="" hx-swap="outerHTML">
          {% for role in department.roles.all %}
            <div class="drop mb-2" data-role-id="{{role.id}}">
              <h3 class="card-title mb-0">{{ role }}</h3>
              {% if role.users.all|length %}
                  <ul class="list-group list-group-flush">
                  {% for user in role.users.all %}
                    <li class="list-group-item" style="padding: 4px;">
                      {% if user.profile_image is not None %}
                      <span class="avatar me-2 avatar-xs" style="background-image: url({{ user.profile_image.get_url }})"></span>
                      {% else %}
                      <span class="avatar me-2 avatar-xs">{{ user.initials }}</span>
                      {% endif %}
                      {{ user.name }}
                    </li>
                  {% endfor %}
                  </ul>
              {% else %}
                {% trans "No users have been added to this role yet." %}
              {% endif %}
            </div>
          {% endfor %}
          {% if department.roles.all|length == 0 %}
            {% trans "No roles have been added to this department yet." %}
            <br/>
            <a type="submit" class="btn btn-primary btn-sm mt-2" href="{% url "people:department_role_create" department.id %}">{% trans "Add role" %}</a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="col-5">
    <div class="card seq-icons sticky-top" id="template-list" style="max-height: calc(44rem + 10px)">
      <div class="card-header">
        <h3 class="card-title">{% translate "Users" %}</h3>
      </div>
      <div class="card-body card-body-scrollable card-body-scrollable-shadow">
        <div class="divide-y">
          {% for user in users %}
          <div>
            <div class="row" draggable="true" style="cursor:grab" data-user-id="{{user.id}}">
              <div class="col">
                <div class="text-truncate">
                  <p style="margin-bottom:0px">{{ user.full_name }}</p>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .drop {
    border-left: 2px solid transparent;
    transform: translateX(0);
    padding-left: 0px;
    transition:
      transform 0.2s ease,
      border-left-color 0.1s ease;
      padding-left 0.3s ease;
  }
  .drop.droppable {
    transform: translateX(5px);
    border-left-color: color-mix(in srgb,var(--tblr-primary) 10%,transparent);
    padding-left: 10px;
  }
</style>
{% endblock extra_css %}
{% block extra_js %}
<script>

var dragged;
var draggedToElement;

function markAsDroppable(element) {
  $(element).addClass("droppable");
}

function removeDroppableClasses() {
  $('.droppable, .not_droppable').removeClass('droppable not_droppable');
}

document.addEventListener("dragstart", function( event ) {
  dragged = event.target;
  event.target.style.opacity = .5;

  $('.drop').each((index, element) => {
    markAsDroppable(element);
  });
}, false);

document.addEventListener("drop", function( event ) {
  // prevent default action
  event.preventDefault()

  const droppedPlace = event.target.closest(".drop")
  draggedToElement = droppedPlace

  if (Boolean(droppedPlace)) {
    console.log(dragged.dataset)
    const userId = dragged.dataset.userId
    const roleId = droppedPlace.dataset.roleId

    htmx.ajax('POST', `/admin/people/colleagues/role/${roleId}/user/${userId}/`, {
      select: "#departments-list", 
      target: "#departments-list",
    })
  }
}, false)

document.addEventListener("dragover", function( event ) {
  // prevent default action
  event.preventDefault();
  event.stopPropagation();
  const droppedPlace = event.target.closest(".drop")
  if (Boolean(droppedPlace)) {
    const type = dragged.dataset.type;
    droppedPlace.style.backgroundColor='rgb(239, 242, 246)';
  }
}, false);

document.addEventListener("dragend", function( event ) {
  removeDroppableClasses();
  event.target.style.opacity = "";
  if (typeof event.target.closest !== "function") {
      return
  }
  if (Boolean(draggedToElement)) {
    draggedToElement.style.backgroundColor='white';
  }
}, false);

document.addEventListener("dragleave", function( event ) {
  // prevent default action
  event.preventDefault();
  event.stopPropagation();
  if (typeof event.target.closest !== "function") {
      return
  }
  const droppedPlace = event.target.closest(".drop")
  if (Boolean(droppedPlace)) {
    const droppedPlace = event.target.closest(".drop")
    droppedPlace.style.backgroundColor='white';
  }
}, false);
</script>
{% endblock extra_js %}
